apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
metadata:
  name: authz-engine-prod

namespace: authz-system

bases:
  - ../../base

commonLabels:
  environment: production

commonAnnotations:
  environment: production
  owner: platform-team
  sla: 99.9%

# Production-specific configurations
replicas:
  - name: authz-engine
    count: 3

images:
  - name: authz-engine
    newTag: v1.0.0

# ConfigMap patches for production
configMapGenerator:
  - name: authz-config
    behavior: merge
    literals:
      - log-level=warn
      - log-format=json
      - cache-enabled=true
      - cache-size=100000
      - cache-ttl=5m
      - workers=16

# HPA patches - aggressive for production
patches:
  - target:
      kind: HorizontalPodAutoscaler
      name: authz-engine-hpa
    patch: |-
      - op: replace
        path: /spec/minReplicas
        value: 3
      - op: replace
        path: /spec/maxReplicas
        value: 10
      - op: replace
        path: /spec/behavior/scaleUp/stabilizationWindowSeconds
        value: 0
      - op: replace
        path: /spec/behavior/scaleDown/stabilizationWindowSeconds
        value: 300

# Include all resources with full monitoring
resources:
  - ../../namespace.yaml
  - ../../deployment.yaml
  - ../../service.yaml
  - ../../configmap.yaml
  - ../../hpa.yaml
  - ../../pdb.yaml
  - ../../ingress.yaml

vars:
  - name: ENVIRONMENT
    literal: production
  - name: NAMESPACE
    objref:
      kind: Namespace
      name: authz-system
    fieldref:
      fieldpath: metadata.name
