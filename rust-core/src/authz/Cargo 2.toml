[package]
name = "cretoai-authz"
version.workspace = true
edition.workspace = true
authors.workspace = true
license.workspace = true
repository.workspace = true

[lib]
crate-type = ["cdylib", "rlib"]

[[bin]]
name = "authz-server"
path = "src/bin/server.rs"

[dependencies]
# HTTP server dependencies
axum = "0.7"
tower = "0.4"
tower-http = { version = "0.5", features = ["trace", "cors"] }
tracing-subscriber = { version = "0.3", features = ["env-filter"] }
hyper = { version = "1.0", features = ["full"] }


# Internal dependencies
cretoai-core = { path = "../core" }
cretoai-crypto = { path = "../crypto" }
cretoai-dag = { path = "../dag" }
cretoai-vault = { path = "../vault" }

# Workspace dependencies
tokio = { workspace = true }
futures = { workspace = true }
async-trait = { workspace = true }
serde = { workspace = true }
serde_json = { workspace = true }
thiserror = { workspace = true }
anyhow = { workspace = true }
tracing = { workspace = true }

# Policy evaluation
cel-interpreter = "0.8"  # CEL (Common Expression Language) - upgraded for latest features
regex = "1.10"
base64 = "0.21"  # For bytes encoding in CEL value conversion

# Caching
lru = "0.12"
dashmap = "5.5"  # Thread-safe HashMap for CEL program cache

# Database - PostgreSQL with sqlx
sqlx = { version = "0.7", features = [
    "runtime-tokio-rustls",
    "postgres",
    "uuid",
    "chrono",
    "json",
    "migrate"
], optional = true }
deadpool-postgres = { version = "0.12", optional = true }

# Utilities
uuid = { workspace = true }
chrono = { workspace = true }
blake3 = { workspace = true }

# WASM support
wasm-bindgen = { workspace = true, optional = true }

[dev-dependencies]
tokio-test = { workspace = true }
proptest = { workspace = true }
criterion = { workspace = true }
tempfile = "3.8"

[features]
default = ["postgres"]
wasm = ["wasm-bindgen"]
dag-audit = []  # Enable DAG-based audit trail
postgres = ["sqlx", "deadpool-postgres"]  # PostgreSQL policy store

[[bench]]
name = "authz_bench"
harness = false

[[bench]]
name = "phase2_benchmarks"
harness = false
