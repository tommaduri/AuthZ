# Production overrides for authz-engine
# Use this file with: helm install --values values-production.yaml

# High availability configuration
replicaCount: 3

image:
  pullPolicy: Always
  # tag: "v1.0.0"  # Set to specific version in production

# Resource limits for production workload
resources:
  limits:
    cpu: 4000m
    memory: 4Gi
  requests:
    cpu: 2000m
    memory: 2Gi

# Aggressive autoscaling for production
autoscaling:
  enabled: true
  minReplicas: 3
  maxReplicas: 20
  targetCPUUtilizationPercentage: 60
  targetMemoryUtilizationPercentage: 70

# Stricter health checks
livenessProbe:
  initialDelaySeconds: 60
  periodSeconds: 10
  timeoutSeconds: 5
  failureThreshold: 3

readinessProbe:
  initialDelaySeconds: 20
  periodSeconds: 5
  timeoutSeconds: 3
  failureThreshold: 3

startupProbe:
  initialDelaySeconds: 0
  periodSeconds: 10
  timeoutSeconds: 5
  failureThreshold: 30

# Production node selection
nodeSelector:
  workload: production

# Tolerate production taints
tolerations:
  - key: "workload"
    operator: "Equal"
    value: "production"
    effect: "NoSchedule"

# Hard anti-affinity for production
affinity:
  podAntiAffinity:
    requiredDuringSchedulingIgnoredDuringExecution:
    - labelSelector:
        matchExpressions:
        - key: app.kubernetes.io/name
          operator: In
          values:
          - authz-engine
      topologyKey: kubernetes.io/hostname

# Ensure at least 2 pods during disruptions
podDisruptionBudget:
  enabled: true
  minAvailable: 2

# Enable ingress for production
ingress:
  enabled: true
  className: "nginx"
  annotations:
    cert-manager.io/cluster-issuer: letsencrypt-prod
    nginx.ingress.kubernetes.io/backend-protocol: "GRPC"
    nginx.ingress.kubernetes.io/grpc-backend: "true"
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
  hosts:
    - host: authz.production.example.com
      paths:
        - path: /
          pathType: Prefix
          backend:
            service:
              port: grpc
  tls:
    - secretName: authz-tls
      hosts:
        - authz.production.example.com

# Production configuration
config:
  logLevel: info
  logFormat: json

  # Enable Redis for production caching
  redis:
    enabled: true
    addr: "redis-master.redis.svc.cluster.local:6379"
    db: 0

# Enable Prometheus monitoring
serviceMonitor:
  enabled: true
  interval: 15s
  scrapeTimeout: 10s
  labels:
    release: prometheus

# Production persistence
persistence:
  enabled: true
  storageClass: "fast-ssd"
  size: 50Gi

# Secrets should be provided via external secret management
# DO NOT commit secrets to Git!
# Set via: --set secrets.jwtSecret="$(kubectl get secret ...)"
secrets:
  jwtSecret: ""  # Set via --set or external secrets
  jwtPublicKey: ""  # Set via --set or external secrets
  redisPassword: ""  # Set via --set or external secrets
